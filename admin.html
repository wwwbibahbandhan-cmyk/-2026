<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bandhan Admin Panel</title>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {margin:0;font-family:'Poppins',sans-serif;background:#f5f5f5;color:#222;}
    .login,.admin {max-width:95%;margin:30px auto;padding:20px;background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.1);}
    h2 {margin-top:0;color:#8b1e3f;font-weight:600;}
    table {width:100%;border-collapse:collapse;margin-top:20px;font-size:0.85rem;}
    th,td {padding:6px 8px;border:1px solid #ddd;vertical-align:top;}
    th {background:#8b1e3f;color:#fff;font-weight:500;}
    .table-thumb {max-width:50px;max-height:50px;border-radius:6px;}
    /* Make images inside the view modal scale naturally */
    #viewModal img {width:100%;height:auto;max-height:80vh;display:block;}

    .btn {padding:4px 8px;border-radius:6px;cursor:pointer;border:none;font-weight:600;font-family:inherit;font-size:0.8rem;}
    .btn-edit {background:#f0b429;color:#000;}
    .btn-del {background:#e74c3c;color:#fff;}
    .btn-exp {background:#8b1e3f;color:#fff;margin-top:12px;}
    .btn-view {background:#3498db;color:#fff;}
    .btn-ver {background:#2ecc71;color:#fff;}
    .hidden {display:none;}
    input[type="password"]{padding:6px 8px;width:200px;border:1px solid #ccc;border-radius:6px;font-family:inherit;}
    /* simple modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px;}
    .modal.open{display:flex;}
    .modal-content{background:#fff;padding:20px;border-radius:10px;max-width:600px;width:100%;max-height:90vh;overflow:auto;}
    .modal-content h3{margin-top:0;color:#8b1e3f;}
  </style>
</head>
<body>

<!-- LOGIN -->
<div class="login" id="loginBox">
  <h2>üîë Admin Login</h2>
  <p>Please enter password:</p>
  <input type="password" id="adminPass" placeholder="Password">
  <button class="btn btn-exp" onclick="checkLogin()">Login</button>
  <p id="loginMsg" style="color:red"></p>
</div>

<!-- ADMIN PANEL -->
<div class="admin hidden" id="adminBox">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h2>üìã Stored Profiles</h2>
    <a href="index.html" class="btn btn-exp">üè† Home</a>
  </div>
  <table id="profileTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Profile For</th>
        <th>Gender</th>
        <th>DOB</th>
        <th>City</th>
        <th>State</th>
        <th>Phone</th>
        <th>Verified</th>
        <th>Photo</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button class="btn btn-exp" onclick="exportCSV()">‚¨á Export CSV</button>
</div>


<!-- Profile modal -->
<div class="modal" id="viewModal">
  <div class="modal-content">
    <h3>Profile Details</h3>
    <div id="profileDetails"></div>
    <button class="btn btn-del" onclick="closeModal()">Close</button>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <h3>Edit Profile</h3>
    <form id="editForm">
      <div id="editFields"></div>
      <div style="margin-top:12px;display:flex;gap:10px;justify-content:flex-end">
        <button type="button" class="btn btn-del" onclick="closeEdit()">Cancel</button>
        <button type="submit" class="btn btn-exp">Save</button>
      </div>
    </form>
  </div>
</div>
<script>
// --- ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ---
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyInN31JzEJHriv_mwpTsCPPUbtOV3N8XpEquq1s1OEvfzCbzbVNHSahyRt1Hg2gbQH/exec";
const PASSWORD = "12345"; 
let allProfiles = [];

// --- ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (ISO to YYYY-MM-DD) ---
function formatToInputDate(isoString) {
  if (!isoString) return "";
  const date = new Date(isoString);
  if (isNaN(date.getTime())) return isoString; 
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// --- ‡ßß. ‡¶≤‡¶ó‡¶á‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï ---
document.getElementById("adminPass").addEventListener("keypress", function(e) {
  if (e.key === "Enter") checkLogin();
});

function checkLogin(){
  const pass = document.getElementById("adminPass").value;
  if(pass === PASSWORD){
    document.getElementById("loginBox").classList.add("hidden");
    document.getElementById("adminBox").classList.remove("hidden");
    fetchProfiles(); 
  } else {
    document.getElementById("loginMsg").textContent = "‚ùå Wrong password!";
  }
}

// --- ‡ß®. ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶∏‡¶æ ---
async function fetchProfiles() {
  const tbody = document.querySelector("#profileTable tbody");
  tbody.innerHTML = `<tr><td colspan="11" style="text-align:center;">Fetching Data...</td></tr>`;
  try {
    const response = await fetch(SCRIPT_URL);
    allProfiles = await response.json();
    renderAdminTable(allProfiles);
  } catch (error) {
    tbody.innerHTML = `<tr><td colspan="11" style="text-align:center;color:red;">Error loading data!</td></tr>`;
  }
}

// --- ‡ß©. ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ---
function renderAdminTable(data) {
  const tbody = document.querySelector("#profileTable tbody");
  tbody.innerHTML = "";
  data.forEach((p, i) => {
    const tr = document.createElement("tr");
    const isVerified = p.status === "verified";
    tr.innerHTML = `
      <td>${p.id || ""}</td>
      <td>${p.fullName || ""}</td>
      <td>${p.profileFor || ""}</td>
      <td>${p.gender || ""}</td>
      <td>${formatToInputDate(p.dob)}</td>
      <td>${p.city || ""}</td>
      <td>${p.state || ""}</td>
      <td>${p.phone || ""}</td>
      <td>${isVerified ? "<span style='color:green;font-weight:bold'>‚úî Verified</span>" : "<span style='color:orange;font-weight:bold'>‚ùå Pending</span>"}</td>
      <td>${p.photo ? `<img class="table-thumb" src="${p.photo}">` : "No Photo"}</td>
      <td>
        <button class="btn btn-view" onclick="viewProfile(${i})">View</button>
        <button class="btn btn-ver" onclick="toggleVerify('${p.id}', '${p.status}')">${isVerified ? "Unverify" : "Approve"}</button>
        <button class="btn btn-edit" onclick="editProfile(${i})">Edit</button>
        <button class="btn btn-del" onclick="deleteProfile('${p.id}')">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

// --- ‡ß™. ‡¶è‡¶°‡¶ø‡¶ü ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤ ‡¶ì‡¶™‡ßá‡¶® (DOB ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∏‡¶π) ---
function editProfile(i) {
  const p = allProfiles[i]; 
  if (!p) return;
  const labels = {
    fullName: "Full Name", fatherName: "Father's Name", motherName: "Mother's Name",
    profileFor: "Profile For", gender: "Gender", dob: "Date of Birth",
    height: "Height", diet: "Diet", maritalStatus: "Marital Status",
    religion: "Religion", community: "Community", motherTongue: "Mother Tongue",
    education: "Education", occupation: "Occupation", income: "Income",
    city: "City", policestation: "Police Station", state: "State",
    pin: "Pin", email: "Email", phone: "Phone", about: "About", preferences: "Preferences"
  };
  const fields = Object.keys(p).filter(k => k !== "photo" && k !== "id" && k !== "status" && k !== "age");
  let html = "";
  fields.forEach(f => {
    let val = p[f] || "";
    let inputType = 'type="text"';
    if (f === 'dob') {
        inputType = 'type="date"';
        val = formatToInputDate(val);
    }
    html += `<div style="margin-bottom:10px;">
        <label><strong>${labels[f] || f}:</strong></label><br>
        <input name="${f}" ${inputType} value="${val}" style="width:100%;padding:8px;margin-top:4px;border:1px solid #ccc;border-radius:6px">
      </div>`;
  });
  html += `<input type="hidden" name="id" value="${p.id}">`;
  document.getElementById("editFields").innerHTML = html;
  document.getElementById("editModal").classList.add("open");
}

// --- ‡ß´. ‡¶∏‡ßá‡¶≠ ‡¶è‡¶°‡¶ø‡¶ü (Duplicate ‡¶∞‡ßã‡¶ß‡ßá Update Logic) ---
document.getElementById("editForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  const saveBtn = e.target.querySelector('button[type="submit"]');
  saveBtn.disabled = true;
  saveBtn.innerText = "Updating...";
  const fd = new FormData(this);
  const updatedData = Object.fromEntries(fd.entries());
  updatedData.action = "edit"; 
  try {
    await fetch(SCRIPT_URL, {
      method: "POST",
      mode: "no-cors",
      body: JSON.stringify(updatedData)
    });
    alert("Profile Updated Successfully!");
    closeEdit();
    setTimeout(() => { fetchProfiles(); }, 1500);
  } catch (err) {
    alert("Error updating profile.");
  } finally {
    saveBtn.disabled = false;
    saveBtn.innerText = "Save";
  }
});

// --- ‡ß¨. ‡¶≠‡¶ø‡¶â ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ (‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶°) ---
function viewProfile(i){
  const p = allProfiles[i];
  let html = `<div style="display:flex;gap:20px;flex-wrap:wrap">
                <div style="flex:2">`;
  for(let key in p){
    if(key !== 'photo') {
      // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá DOB ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßá ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
      let displayValue = (key === 'dob') ? formatToInputDate(p[key]) : (p[key] || "N/A");
      html += `<p><strong>${key}:</strong> ${displayValue}</p>`;
    }
  }
  html += `</div><div style="flex:1">
           ${p.photo ? `<img src="${p.photo}" style="width:100%;border-radius:10px">` : "No Photo"}
           </div></div>`;
  document.getElementById("profileDetails").innerHTML = html;
  document.getElementById("viewModal").classList.add("open");
}

// --- ‡ß≠. ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á ‡¶è‡¶¨‡¶Ç ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ---
async function toggleVerify(id, currentStatus) {
  const newStatus = currentStatus === "verified" ? "pending" : "verified";
  if(!confirm(`Change status to ${newStatus}?`)) return;
  try {
    await fetch(SCRIPT_URL, {
      method: "POST",
      mode: "no-cors",
      body: JSON.stringify({ action: "approve", id: id, status: newStatus })
    });
    alert("Status Updated!");
    fetchProfiles();
  } catch (err) { alert("Error!"); }
}

async function deleteProfile(id) {
  if (!confirm("Are you sure you want to delete this profile?")) return;
  try {
    await fetch(SCRIPT_URL, {
      method: "POST",
      mode: "no-cors",
      body: JSON.stringify({ action: "delete", id: id })
    });
    alert("Delete Request Sent!");
    fetchProfiles(); 
  } catch (err) { alert("Failed to delete."); }
}

function closeEdit() { document.getElementById("editModal").classList.remove("open"); }
function closeModal(){ document.getElementById("viewModal").classList.remove("open"); }

function exportCSV() {
  if (!allProfiles.length) return;
  const headers = Object.keys(allProfiles[0]);
  const csv = [headers.join(","), ...allProfiles.map(p => headers.map(h => `"${(p[h]||"")}"`).join(","))].join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "profiles.csv";
  a.click();
}
</script>
</body>
</html>
